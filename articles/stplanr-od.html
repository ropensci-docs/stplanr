<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="stplanr">
<title>Origin-destination data with stplanr • stplanr</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Origin-destination data with stplanr">
<meta property="og:description" content="stplanr">
<meta property="og:image" content="https://docs.ropensci.org/stplanr/logo.png">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">stplanr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.1.2.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../articles/stplanr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/merging-route-networks.html">Merging route networks</a>
    <a class="dropdown-item" href="../articles/stplanr-od.html">Origin-destination data with stplanr</a>
    <a class="dropdown-item" href="../articles/stplanr-paper.html">stplanr: A Package for Transport Planning</a>
    <a class="dropdown-item" href="../articles/stplanr-parallel.html">Parallel routing and performance with stplanr</a>
    <a class="dropdown-item" href="../articles/stplanr-route-nets.html">Route networks with stplanr</a>
    <a class="dropdown-item" href="../articles/stplanr-routing.html">Transport routing with stplanr</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/stplanr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Origin-destination data with stplanr</h1>
                        <h4 data-toc-skip class="author">Robin Lovelace and Edward Leigh</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/stplanr/blob/HEAD/vignettes/stplanr-od.Rmd" class="external-link"><code>vignettes/stplanr-od.Rmd</code></a></small>
      <div class="d-none name"><code>stplanr-od.Rmd</code></div>
    </div>

    
    
<p>Note: an updated version of this vignette, called ‘od’, is available in the <code>od</code> package. View it as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"od"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html" class="external-link">vignette</a></span><span class="op">(</span><span class="st">"od"</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction-what-is-od-data">Introduction: what is OD data?<a class="anchor" aria-label="anchor" href="#introduction-what-is-od-data"></a>
</h2>
<p>As the name suggests, origin-destination (OD) data represents movement through geographic space, from an origin (O) to a destination (D). Sometimes also called ‘<a href="https://www.ons.gov.uk/census/2011census/2011censusdata/originanddestinationdata" class="external-link">flow data</a>’, OD datasets contain details of trips between two geographic points or, more commonly, zones (which are often represented by a zone centroid). Most OD datasets refer to start and end locations with ‘ID’ columns containing character strings such as <code>zone1</code>. These IDs refer to a geographic feature in a separate geographic dataset. Origin and destination locations are sometimes represented as geographic coordinates.</p>
<p>OD datasets typically contain multiple non geographic attributes. These usually include, at a minimum, the number of trips that take place from the origin to the destination over a given time period (e.g. a typical work day). Additional attributes can include breakdown by the mode(s) of transport used for the trips. Usually only a single mode is captured (trips made by a combination of cycle-train-walk modes are often counted only as ‘train’ trips). Additional disaggregations of overall counts may include trip counts at different time periods.</p>
<p>Many OD datasets omit information. If there is only one time period, then this resides in the metadata for the whole data set. There is rarely any information about the path taken between the start and end points. It is typically the job of the analyst to use a routing service (such as <a href="https://github.com/riatelab/osrm" class="external-link">OSRM</a>, Google Directions API, <a href="https://cran.r-project.org/package=cyclestreets" class="external-link">CycleStreets.net</a> or <a href="https://github.com/GIScience/openrouteservice-r/" class="external-link">OpenRouteService</a>) or an assignment model (such as those contained in proprietary software such as SATURN and Visum) to identify likely routes with reference to shortest path algorithms or generalised cost minimisation algorithms (which account for monetary plus time and quality ‘costs’).</p>
</div>
<div class="section level2">
<h2 id="the-importance-of-od-data">The importance of OD data<a class="anchor" aria-label="anchor" href="#the-importance-of-od-data"></a>
</h2>
<p>Despite the rather dull name, OD datasets are a vital part of the modern world: they underpin analysis and models that influence current <em>and future</em> transport systems. Historically, these models, and the OD datasets that drove them, were used to plan for car-dominated cities <span class="citation">(Boyce and Williams 2015)</span>. Now that there is growing evidence of the negative impacts car domination, however, there is a strong argument for transport models being re-purposed. Origin-destination data can be part of the solution.</p>
<p>From a health perspective transport planning, supported by OD data and analysed primarily using proprietary software and opaque methods, has failed: roads are now the largest cause of death of young people worldwide, killing more than <a href="https://www.who.int/publications/i/item/9789241565684" class="external-link">1 million</a> people each year <span class="citation">(World Health Organization 2018)</span>. Even ignoring problems such as air pollution, obesity and climate change, it is clear that current transport systems are unsustainable. There are other reasons why transport data analysis and software are important <span class="citation">(Lovelace and Ellison 2018)</span>.</p>
<p>The purpose of this vignette is to introduce OD data, an important component of many transport planning models, with examples based on data and functions from the stplanr package. The aim is to enable you to use OD data to inform more sustainable transport plans, for example by identifying ‘desire lines’ along which policies could cause a modal switch away from cars and towards lower energy modes such as walking, cycling, and public transport.</p>
</div>
<div class="section level2">
<h2 id="an-example-od-dataset">An example OD dataset<a class="anchor" aria-label="anchor" href="#an-example-od-dataset"></a>
</h2>
<p>OD data can be accessed from a range of sources (we will see code that downloads many thousands of OD pairs later in this vignette). Some ‘data carpentry’ may be needed before the OD data is ready for analysis. This vignette does not cover cleaning OD data: we assume you know R and come with ‘tidy’ data <span class="citation">(Wickham 2014)</span>, in which each row represents travel between an origin and a destination (typically zones represented by zone IDs), and each column represents an attribute such as number of trips or vehichle counts by mode or straight line distance.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt; It may be difficult to convert between ‘number of trip’ and ‘number of vehicle’ counts for modes in which a single vehicle can contain many people, such as cars (a problem that can be overcome when surveys differentiate between car driver and ‘car passenger’ as distinct modes), buses and trams if occupancy levels are unknown. Typically OD data only report single stage trips, but multi-modal trips such as walk-rail-cycle can be represented when such a combination of modes is represented by a new, unique, mode. &lt;/p&gt;"><sup>1</sup></a></p>
<p>In simple terms OD data looks like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/stplanr">stplanr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu">stplanr</span><span class="fu">::</span><span class="va"><a href="../reference/od_data_sample.html">od_data_sample</a></span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"rail|name|moto|car|tax|home|la_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">14</span>, wt <span class="op">=</span> <span class="va">all</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span>
<span><span class="va">od</span></span></code></pre></div>
<!-- The next section discusses this, and other, representations of OD data. -->
<!-- # Representations of OD data -->
<p>Like all data, the object <code>od</code>, created in the preceding code chunk, comes from a specific context: the 2011 <a href="https://ukdataservice.ac.uk/learning-hub/census/" class="external-link">UK Census</a> questions:</p>
<ul>
<li>In your main job, what is the address of your workplace?</li>
<li>How do you usually travel to work (for the longest part, by distance, of your usual journey to work)?
<ul>
<li>Work mainly at or from home</li>
<li>Underground, metro, light rail, tram</li>
<li>Train</li>
<li>…</li>
</ul>
</li>
</ul>
<p>The object <code>od</code> is a data frame containing aggregated answers to these questions (see <code>?pct::get_od()</code> for details). It is <em>implicitly geographic</em>: the first two columns refer to geographic entities but do not contain coordinates themselves (OD coordinates are covered below). Other columns contain attributes associated with each OD pair, typically counting how many people travel by mode of transport. OD data can be represented in a number of ways, as outlined in the next sections.</p>
</div>
<div class="section level2">
<h2 id="origin-destination-pairs-long-form">Origin-destination pairs (long form)<a class="anchor" aria-label="anchor" href="#origin-destination-pairs-long-form"></a>
</h2>
<p>The most useful way of representing OD data is the ‘long’ data frame format described above. This is increasingly the format used by official statistical agencies, including the UK’s Office for National Statistics (ONS), who provide origin destination data as a <code>.csv</code> file. Typically, the first column is the zone code of origin and the second column is the zone code of the destination, as is the case with the object <code>od</code>. Subsequent columns contain attributes such as <code>all</code>, meaning trips by all modes, as illustrated below (we will see a matrix representation of this subset of the data in the next section):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span></code></pre></div>
<p><code>geo_code1</code> refers to the origin, <code>geo_code2</code> refers to the destination.</p>
<p>Additional columns can represent addition attributes, such as number of trips by time, mode of travel, type of person, or trip purpose. The <code>od</code> dataset contains column names representing mode of travel (train, bus, bicycle etc), as can be seen with <code>names(od[-(1:2)])</code>. These ‘mode’ columns contain integers in the example data, but contain characters, dates and other data types, taking advantage of the flexibility of data frames.</p>
</div>
<div class="section level2">
<h2 id="origin-destination-matrices">Origin destination matrices<a class="anchor" aria-label="anchor" href="#origin-destination-matrices"></a>
</h2>
<p>The ‘OD matrix’ representation of OD data represents each attribute column in the long form as a separate matrix. Instead of rows representing OD pairs, rows represent all travel from each origin to all destinations (represented as columns). The <strong>stplanr</strong> function <code><a href="../reference/od_to_odmatrix.html">od_to_odmatrix()</a></code> converts between the ‘long’ to the ‘matrix’ form on a per column basis, as illustrated below:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/od_to_odmatrix.html">od_to_odmatrix</a></span><span class="op">(</span><span class="va">od</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">od_matrix</span><span class="op">)</span></span>
<span><span class="va">od_matrix</span></span></code></pre></div>
<p>Note that row and column names are now zone codes. The cell in row 1 and column 2 (<code>od_matrix[1, 2]</code>), for example, reports that there are 94 trips from zone <code>E02002361</code> to zone <code>E02002393</code>. In the case above, no people travel between the majority of the OD pair combinations, as represented by the <code>NA</code>s. OD matrices are a relatively rudimentary data structure that pre-date R’s <code>data.frame</code> class. Typically, they only contained integer counts, providing small and simple datasets that could be used in 20<sup>th</sup> Century transport modelling software running on limited 20<sup>th</sup> Century hardware.</p>
<p>Although ‘OD matrix’ is still sometimes used informally to refer to any OD datadset, the long OD pair representation is recommended: OD matrices become unwieldy for large OD datasets, which are likely to be sparse, with many empty cells represented by NAs. Furthermore, to represent many attributes in matix format, multiple lists of OD matrices or ‘OD arrays’ must be created. This is demonstrated in the code chunk below, which represents travel between OD pairs by all modes and by bike:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"all"</span>, <span class="st">"bicycle"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/od_to_odmatrix.html">od_to_odmatrix</a></span><span class="op">(</span><span class="va">od</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_code1"</span>, <span class="st">"geo_code2"</span>, <span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The function <code><a href="../reference/odmatrix_to_od.html">odmatrix_to_od()</a></code> can converts OD matrices back into the more convenient long form:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/odmatrix_to_od.html">odmatrix_to_od</a></span><span class="op">(</span><span class="va">od_matrix</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="inter-and-intra-zonal-flows">Inter and intra-zonal flows<a class="anchor" aria-label="anchor" href="#inter-and-intra-zonal-flows"></a>
</h2>
<p>A common, and sometimes problematic, feature of OD data is ‘intra-zonal flows’. These are trips that start and end in the same zone. The proportion of travel that is intra-zonal depends largely on the size of the zones used. It is often useful to separate intra-zonal and inter-zonal flows at the outset, as demonstrated below:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">od_inter</span> <span class="op">&lt;-</span> <span class="va">od</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_code1</span> <span class="op">!=</span> <span class="va">geo_code2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">od_intra</span> <span class="op">&lt;-</span> <span class="va">od</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_code1</span> <span class="op">==</span> <span class="va">geo_code2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Intra-zonal OD pairs represent short trips (up to the size of the zone within which the trips take place) so are sometimes ignored in OD data analyis. However, intra-zonal flows can be valuable, for example in measuring the amount of localised transport activity and as a sign of local economies.</p>
</div>
<div class="section level2">
<h2 id="oneway-lines">Oneway lines<a class="anchor" aria-label="anchor" href="#oneway-lines"></a>
</h2>
<p>Another subtly with some (<a href="https://icaci.org/files/documents/ICC_proceedings/ICC2013/_extendedAbstract/393_proceeding.pdf" class="external-link">symetric</a>, where origins and destinations can be the same points) OD data is that oneway flows can hide the extent of bidirectional flows in plots and other types of analysis. This is illustrated below for a sample of the <code>od</code> dataset:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">od_min</span> <span class="op">&lt;-</span> <span class="va">od_data_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">9</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">od_oneway</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/od_oneway.html">od_oneway</a></span><span class="op">(</span><span class="va">od_min</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note that in the second dataset there are only 2 rows instead of 3. The function <code><a href="../reference/od_oneway.html">od_oneway()</a></code> aggregates oneway lines to produce bidirectional flows. By default, it returns the sum of each numeric column for each bidirectional origin-destination pair.</p>
</div>
<div class="section level2">
<h2 id="desire-lines">Desire lines<a class="anchor" aria-label="anchor" href="#desire-lines"></a>
</h2>
<p>The previous representations of OD data are all implicitly geographic: their coordinates are not contained in the data, but associated with another object that <em>is</em> geographic, typically a zone or a zone centroid. This is problematic, meaning that multiple objects or files are required to fully represent the same data. Desire line representations overcome this issue. They are geographic lines between origin and destination, with the same attributes as in the ‘long’ representation.</p>
<p><code><a href="../reference/od2line.html">od2line()</a></code> can convert long form OD data to desire lines. The second argument is a zone or a centroid dataset that contains ‘zone IDs’ that match the IDs in the first and second columns of the OD data, as illustrated below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">zones_sf</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span></span>
<span><span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/od2line.html">od2line</a></span><span class="op">(</span>flow <span class="op">=</span> <span class="va">od_inter</span>, zones <span class="op">=</span> <span class="va">z</span><span class="op">)</span></span></code></pre></div>
<p>The preceding code chunk created a zones object called <code>z</code>, the coordinates of which were used to convert the object <code>od</code> into <code>l</code>, which are geographic desire lines. The desire line object is stored in as a geographic simple features object, which has the same number of rows as does the object <code>od</code> and one more column:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span></code></pre></div>
<p>The new column is the geometry column, which can be plotted as follows:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">l</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span></span></code></pre></div>
<p>By default, plotting <code>l</code> shows the attributes for each line:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span></span></code></pre></div>
<p>Because these lines have a coordinate reference system (CRS) inherited from the zones data, they can also be plotted on an interactive map, as follows (result only shown if webshot is installed):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/" class="external-link">leaflet</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rstudio.github.io/leaflet/reference/leaflet.html" class="external-link">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addTiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rstudio.github.io/leaflet/reference/map-layers.html" class="external-link">addPolygons</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">l</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="non-matching-ids">Non-matching IDs<a class="anchor" aria-label="anchor" href="#non-matching-ids"></a>
</h3>
<p>Note that in some OD datasets there may be IDs that match no zone. We can simulate this situation by setting the third origin ID of <code>od</code> to <code>nomatch</code>, a string that is not in the zones ID:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">od</span><span class="op">$</span><span class="va">geo_code2</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"nomatch"</span></span>
<span><span class="fu"><a href="../reference/od2line.html">od2line</a></span><span class="op">(</span><span class="va">od</span>, <span class="va">z</span><span class="op">)</span></span></code></pre></div>
<p>You should clean your OD data and ensure all ids in the first two columns match the ids in the first column of the zone data before running <code><a href="../reference/od2line.html">od2line()</a></code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="a-larger-example-commuter-trips-in-london">A larger example: commuter trips in London<a class="anchor" aria-label="anchor" href="#a-larger-example-commuter-trips-in-london"></a>
</h2>
<p>The minimal example dataset we’ve been using so far is fine for demonstrating the key concepts of OD data. But for more advanced topic, and to get an idea of what is possible with OD data at a city level, it helps to have a larger dataset.</p>
<p>We will use an example dataset representing commuting in London, accessed as follows (note: these code chunks are not evaluated in the vignette because it starts by downloading 2.4 million rows and could take a few minutes to run). First, we can use the <code>pct</code> package to download official data from the UK (note the addition of the % active column):</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get nationwide OD data</span></span>
<span><span class="va">od_all</span> <span class="op">&lt;-</span> <span class="fu">pct</span><span class="fu">::</span><span class="fu"><a href="https://itsleeds.github.io/pct/reference/get_od.html" class="external-link">get_od</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">od_all</span><span class="op">)</span></span>
<span><span class="co"># &gt; 2402201</span></span>
<span><span class="va">od_all</span><span class="op">$</span><span class="va">Active</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">od_all</span><span class="op">$</span><span class="va">bicycle</span> <span class="op">+</span> <span class="va">od_all</span><span class="op">$</span><span class="va">foot</span><span class="op">)</span> <span class="op">/</span></span>
<span>  <span class="va">od_all</span><span class="op">$</span><span class="va">all</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="va">centroids_all</span> <span class="op">&lt;-</span> <span class="fu">pct</span><span class="fu">::</span><span class="fu"><a href="https://itsleeds.github.io/pct/reference/get_centroids_ew.html" class="external-link">get_centroids_ew</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">centroids_all</span><span class="op">)</span></span>
<span><span class="co"># &gt; 7201</span></span>
<span><span class="va">london</span> <span class="op">&lt;-</span> <span class="fu">pct</span><span class="fu">::</span><span class="va"><a href="https://itsleeds.github.io/pct/reference/pct_regions.html" class="external-link">pct_regions</a></span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region_name</span> <span class="op">==</span> <span class="st">"london"</span><span class="op">)</span></span>
<span><span class="va">centroids_london</span> <span class="op">&lt;-</span> <span class="va">centroids_all</span><span class="op">[</span><span class="va">london</span>, <span class="op">]</span></span>
<span><span class="va">od_london</span> <span class="op">&lt;-</span> <span class="va">od_all</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_code1</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">centroids_london</span><span class="op">$</span><span class="va">msoa11cd</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_code2</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">centroids_london</span><span class="op">$</span><span class="va">msoa11cd</span><span class="op">)</span></span>
<span><span class="va">od_london</span> <span class="op">&lt;-</span> <span class="va">od_all</span><span class="op">[</span></span>
<span>  <span class="va">od_all</span><span class="op">$</span><span class="va">geo_code1</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">centroids_london</span><span class="op">$</span><span class="va">msoa11cd</span> <span class="op">&amp;</span></span>
<span>    <span class="va">od_all</span><span class="op">$</span><span class="va">geo_code2</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">centroids_london</span><span class="op">$</span><span class="va">msoa11cd</span>,</span>
<span><span class="op">]</span></span></code></pre></div>
<p>Now that we have the input OD data (in <code>od_london</code>) and zones (population-weighted centroids in <code>cents_london</code> in this case), can can convert them to desire lines:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">desire_lines_london</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/od2line.html">od2line</a></span><span class="op">(</span><span class="va">od_london</span>, <span class="va">centroids_london</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">desire_lines_london</span><span class="op">)</span></span>
<span><span class="co"># &gt; 352654</span></span></code></pre></div>
<p>Even after filering flows to keep only those with origins <em>and</em> destinations in London, there are still more than 300k flows. That is a lot to plot. So we’ll further subset them, first so they only contain inter-zonal flows (which are actually lines, intra-zonal flows are lines with length 0, which are essentially points) and second to contain only flows containing above a threshold level of flows:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">min_trips_threshold</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">desire_lines_inter</span> <span class="op">&lt;-</span> <span class="va">desire_lines_london</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_code1</span> <span class="op">!=</span> <span class="va">geo_code2</span><span class="op">)</span></span>
<span><span class="va">desire_lines_intra</span> <span class="op">&lt;-</span> <span class="va">desire_lines_london</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_code1</span> <span class="op">==</span> <span class="va">geo_code2</span><span class="op">)</span></span>
<span><span class="va">desire_lines_top</span> <span class="op">&lt;-</span> <span class="va">desire_lines_inter</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">all</span> <span class="op">&gt;=</span> <span class="va">min_trips_threshold</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">desire_lines_top</span><span class="op">)</span></span>
<span><span class="co"># &gt; 28879</span></span></code></pre></div>
<p>If we do any analysis on this dataset, it’s important to know how representative it is of all flows. A crude way to do this is to calculate the proportion of lines and trips that are covered in the dataset:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">desire_lines_top</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">desire_lines_london</span><span class="op">)</span></span>
<span><span class="co"># &gt; 0.08189046</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">desire_lines_top</span><span class="op">$</span><span class="va">all</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">desire_lines_london</span><span class="op">$</span><span class="va">all</span><span class="op">)</span></span>
<span><span class="co"># &gt; 0.557343</span></span></code></pre></div>
<p>This shows that only 8% of the lines contain more than half (55%) of the total number of trips.</p>
</div>
<div class="section level2">
<h2 id="plotting-origin-destination-data">Plotting origin-destination data<a class="anchor" aria-label="anchor" href="#plotting-origin-destination-data"></a>
</h2>
<p>Once you have an OD dataset of a size that can be plotted (20,000 desire lines is quick to plot on most computers) a logical next stage is to plot it, e.g. with <code>sf</code>’s <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">desire_lines_top</span><span class="op">[</span><span class="st">"all"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>You may be disapointed by the result, which is more of a ‘hay stack’ plot than an intuitive illustration of flows across the city. To overcome this issue, you can set the aesthetics to emphasize with important flows, e.g. by line width in <code>sf</code>’s plotting system:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lwd</span> <span class="op">&lt;-</span> <span class="va">desire_lines_top</span><span class="op">$</span><span class="va">all</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">desire_lines_top</span><span class="op">$</span><span class="va">all</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span></span>
<span><span class="va">desire_lines_top</span><span class="op">$</span><span class="va">percent_dont_drive</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">-</span> <span class="va">desire_lines_top</span><span class="op">$</span><span class="va">car_driver</span> <span class="op">/</span> <span class="va">desire_lines_top</span><span class="op">$</span><span class="va">all</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">desire_lines_top</span><span class="op">[</span><span class="st">"percent_dont_drive"</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="va">lwd</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">70</span>, <span class="fl">80</span>, <span class="fl">90</span>, <span class="fl">95</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This is better, but is still not ideal: the code was not intuitive to write, and the result is still not publication quality. Instead, it makes sense to make a dedicated mapping package such <strong>tmap</strong>, as outlined in the <a href="https://r.geocompx.org/adv-map.html" class="external-link">visualisation chapter</a> of the open source book <em>Geocomputation with R</em> <span class="citation">(Lovelace, Nowosad, and Meunchow 2019)</span>. As shown in the transport chapter of that book, OD flows can be visualised with the following code:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-tmap.github.io/tmap/" class="external-link">tmap</a></span><span class="op">)</span></span>
<span><span class="va">desire_lines_top</span> <span class="op">&lt;-</span> <span class="va">desire_lines_top</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">Active</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">london</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html" class="external-link">tm_borders</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">desire_lines_top</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span></span>
<span>    palette <span class="op">=</span> <span class="st">"plasma"</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">40</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>    lwd <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    scale <span class="op">=</span> <span class="fl">9</span>,</span>
<span>    title.lwd <span class="op">=</span> <span class="st">"Number of trips"</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"Active"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Active travel (%)"</span>,</span>
<span>    legend.lwd.show <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_scale_bar.html" class="external-link">tm_scale_bar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_layout</a></span><span class="op">(</span></span>
<span>    legend.bg.alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    legend.bg.color <span class="op">=</span> <span class="st">"white"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The above plot contains much information, providing a visual overview of the transport pattern in the city, telling us that:</p>
<ul>
<li>It is a monocentric city, with most flows going to the centre.</li>
<li>Active transport is geographically dependent, dominating in the central north of the city and with limited uptake on the outskirts of the city.</li>
<li>Although the city centre dominates, there are many small clusters of flows in the outer region, for example near Heathrow airport, which is located in the far west of the map.</li>
</ul>
<p>Plotting OD data in this way can tell us much about cities, each of which has a different travel pattern. You can use the same code to visualise mobility patterns in any city. See Section <a href="https://r.geocompx.org/transport.html" class="external-link">12.4</a> of <em>Geocomputation with R</em> to see results for Bristol, a more polycentric city with a lower average percentage of travel by walking and cycling.</p>
</div>
<div class="section level2">
<h2 id="summaries-by-origin-and-destination">Summaries by origin and destination<a class="anchor" aria-label="anchor" href="#summaries-by-origin-and-destination"></a>
</h2>
<p>It is possible to group OD data by origin and destination to gain information at the zone level. The code and resulting plot below, for example, summarises the number of people departing from each zone by mode:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zones_london</span> <span class="op">&lt;-</span> <span class="fu">pct</span><span class="fu">::</span><span class="fu"><a href="https://itsleeds.github.io/pct/reference/get_pct_zones.html" class="external-link">get_pct_zones</a></span><span class="op">(</span><span class="st">"london"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="st">"geo_code"</span><span class="op">)</span></span>
<span><span class="va">origin_attributes</span> <span class="op">&lt;-</span> <span class="va">desire_lines_top</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_code1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarize_if</a></span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">sum</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>geo_code <span class="op">=</span> <span class="va">geo_code1</span><span class="op">)</span></span>
<span><span class="co"># origin_attributes &lt;-</span></span>
<span><span class="va">zones_origins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">zones_london</span>, <span class="va">origin_attributes</span>, by <span class="op">=</span> <span class="st">"geo_code"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">zones_origins</span>, border <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
<p>We can observe a number of features, including that:</p>
<ul>
<li>Rail is much more common in the south, reflecting the greater density of the local rail network, with short distances between stops, in the South of the city.</li>
<li>Cars dominat in the outer fringes, especiall in the West.</li>
<li>Taxi and motorbike use have intriguing clusters in the West (perhaps around the wealthy Kensington area for taxis).</li>
</ul>
<p>The pattern is quite different when we calculate the destinations:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">destination_attributes</span> <span class="op">&lt;-</span> <span class="va">desire_lines_top</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_code2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarize_if</a></span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">sum</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>geo_code <span class="op">=</span> <span class="va">geo_code2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"geo_|all"</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/funs.html" class="external-link">funs</a></span><span class="op">(</span><span class="va">.</span> <span class="op">/</span> <span class="va">all</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">zones_london</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"geo_code"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">destination_attributes</span>, border <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>Despite the importance of origin-destination datasets for transport research, there are surprisingly few guides dedicated to working with them using open source software. The following suggestions are based on my own reading — if you have any other suggestions of good resources for working with OD data, let me know!</p>
<ul>
<li>Section <a href="https://r.geocompx.org/transport.html" class="external-link">12.4</a> of <em>Geocomputation with R</em> <span class="citation">(Lovelace, Nowosad, and Meunchow 2019)</span> puts OD data in the wider context of geographic transport data.</li>
<li>
<span class="citation">Martin et al. (2018)</span> describe methods for classifying OD pairs based on demographic data.</li>
<li>The <a href="https://kepler.gl/demo/ukcommute" class="external-link">kepler.gl</a> website provides a nifty web application for visualising OD data.</li>
<li>Documentation for the open source microscopic transport modelling software <a href="https://sumo.dlr.de/userdoc/Demand/Importing_O/D_Matrices.html" class="external-link">SUMO</a> describes ways of reading-in OD file formats not covered in this vignette.</li>
<li>An excellent introduction to modelling and visualising OD data in the <a href="https://github.com/riatelab/flows/blob/master/vignettes/flows.Rmd" class="external-link">introductory vignette</a> of the <code>flows</code> R package.</li>
</ul>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>In summary, <code>stplanr</code> provides many functions for working with OD data. OD data is an important component in transport planning and modelling that can, if used with creativity and skill, could assist with sustainable transport planning and the global <a href="https://www.sei.org/wp-content/uploads/2019/01/realizing-a-just-and-equitable-transition-away-from-fossil-fuels.pdf" class="external-link">transition away from fossil fuels</a>. There are many other things can be done with OD data, some of which could be supported by future versions of this package. To suggest new features of otherwise get in touch, see the <code>stplanr</code> issue tracker at <a href="https://github.com/ropensci/stplanr/issues" class="external-link">github.com/ropensci/stplanr</a>.</p>
<!-- # Applications -->
<!-- This is represented in the file `lines_cars.Rds`, representing the top 20,000 desire lines at the MSOA-MSOA level in England and Wales by the number of car km used for travel to work, which can be downloaded, read-in and plotted as follows: -->
<!-- Based on the estimate of the average energy use per km being 2.5 MJ, and that these return trips are made on average 200 times per year, with a circuity of 1.3, we can estimate the total energy use of the 'high energy commutes' as follows: -->
<!-- That represents ~10 petajoules (PJ), only for the top 20,000 most energy intensive commutes. -->
<!-- That may seem like a lot, but represents only a fraction of the UK's total energy use of [~200 Mtoe](https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/729451/DUKES_PN.pdf) (8400 PJ). -->
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-boyce_forecasting_2015" class="csl-entry">
Boyce, David E., and Huw C. W. L. Williams. 2015. <em>Forecasting <span>Urban</span> <span>Travel</span>: <span>Past</span>, <span>Present</span> and <span>Future</span></em>. Edward Elgar Publishing.
</div>
<div id="ref-lovelace_stplanr_2018" class="csl-entry">
Lovelace, Robin, and Richard Ellison. 2018. <span>“Stplanr: <span>A Package</span> for <span>Transport Planning</span>.”</span> <em>The R Journal</em> 10 (2): 7–23. <a href="https://doi.org/10.32614/RJ-2018-053" class="external-link">https://doi.org/10.32614/RJ-2018-053</a>.
</div>
<div id="ref-lovelace_geocomputation_2019" class="csl-entry">
Lovelace, Robin, Jakub Nowosad, and Jannes Meunchow. 2019. <em>Geocomputation with <span>R</span></em>. CRC Press. <a href="https://r.geocompx.org/" class="external-link">https://r.geocompx.org/</a>.
</div>
<div id="ref-martin_origin-destination_2018" class="csl-entry">
Martin, David, Christopher Gale, Samantha Cockings, and Andrew Harfoot. 2018. <span>“Origin-Destination Geodemographics for Analysis of Travel to Work Flows.”</span> <em>Computers, Environment and Urban Systems</em> 67 (January): 68–79. <a href="https://doi.org/10.1016/j.compenvurbsys.2017.09.002" class="external-link">https://doi.org/10.1016/j.compenvurbsys.2017.09.002</a>.
</div>
<div id="ref-wickham_tidy_2014" class="csl-entry">
Wickham, Hadley. 2014. <span>“Tidy <span>Data</span>.”</span> <em>Journal of Statistical Software</em> 59 (10). <a href="https://doi.org/10.18637/jss.v059.i10" class="external-link">https://doi.org/10.18637/jss.v059.i10</a>.
</div>
<div id="ref-world_health_organization_global_2018" class="csl-entry">
World Health Organization. 2018. <em>Global <span>Status</span> <span>Report</span> <span>On</span> <span>Road</span> <span>Safety</span> 2018</em>. S.l. <a href="https://www.who.int/publications/i/item/9789241565684" class="external-link">https://www.who.int/publications/i/item/9789241565684</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
